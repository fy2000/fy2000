<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>鼎科战力中心</title>
	<style type="text/css">
		header{
			background-color: black; 
			color: white; 
			text-align: center; 
			line-height: 100px;
		}
	</style>
	<script>
		function floatround(num){
			var strnum = num.toString().match(/^\d+(?:\.\d{0,2})?/);
			return strnum;
		}

		
        //绘制饼图  
        function drawCircle(canvasId, data_arr, color_arr, text_arr)  
        {  
            var c = document.getElementById(canvasId);  
            var ctx = c.getContext("2d");  

            var radius = c.height / 2 - 20; //半径  
            var ox = radius + 20, oy = radius + 20; //圆心  

            var width = 30, height = 10; //图例宽和高  
            var posX = ox * 2 + 20, posY = 30;   //  
            var textX = posX + width + 5, textY = posY + 10;  

            var startAngle = 0; //起始弧度  
            var endAngle = 0;   //结束弧度  
            for (var i = 0; i < data_arr.length; i++)  
            {  
                //绘制饼图  
                endAngle = endAngle + data_arr[i] * Math.PI * 2; //结束弧度  
                ctx.fillStyle = color_arr[i];  
                ctx.beginPath();  
                ctx.moveTo(ox, oy); //移动到到圆心  
                ctx.arc(ox, oy, radius, startAngle, endAngle, false);  
                ctx.closePath();  
                ctx.fill();  
                startAngle = endAngle; //设置起始弧度  

                //绘制比例图及文字  
                ctx.fillStyle = color_arr[i];  
                ctx.fillRect(posX, posY + 20 * i, width, height);  
                ctx.moveTo(posX, posY + 20 * i);  
                ctx.font = 'bold 12px 微软雅黑';    //斜体 30像素 微软雅黑字体  
                ctx.fillStyle = color_arr[i]; //"#000000";  
                var percent = text_arr[i] + "：" + floatround(100 * data_arr[i]) + "%";  
                ctx.fillText(percent, textX, textY + 20 * i);  
            }  
        }

        function deawLineChart(canvasId, count_arr) {
        	var gd = document.getElementById(canvasId);  
            var gc = gd.getContext("2d");

            var orgpoint = {
            	x: 50,
            	y: gd.height - 50
            }

            var haxis_length = gd.width - 50 - orgpoint.x;
            var vaxis_length = orgpoint.y - 50;

            //画横坐标
            gc.beginPath();
            gc.moveTo( orgpoint.x, orgpoint.y );
            gc.lineTo( gd.width - 50, orgpoint.y );
            gc.stroke();

            //画纵坐标
            gc.beginPath();
            gc.moveTo( orgpoint.x, orgpoint.y );
            gc.lineTo( orgpoint.x, 50 );
            gc.stroke();

            var hunit = haxis_length / 12;
            var vunit = vaxis_length / 5000;

            //画横轴刻度线
            for (var i = 0; i <= 12; i++) {
            	gc.beginPath();
            	gc.moveTo(orgpoint.x + i * hunit, orgpoint.y );
                gc.lineTo(orgpoint.x + i * hunit, orgpoint.y - 5);
                gc.stroke();
            }

            //画纵轴刻度线
            for (var i = 0; i <= 5000; i+=500) {
            	gc.beginPath();
            	gc.moveTo(orgpoint.x, orgpoint.y - i * vunit);
                gc.lineTo(orgpoint.x + 5, orgpoint.y - i * vunit);
                gc.stroke();
            }

            //连线
            gc.beginPath();
            for (var i = 0; i < count_arr.length; i++) {
            	if (i == 0){
            		gc.moveTo(orgpoint.x + (i + 1) * hunit, orgpoint.y - count_arr[i] * vunit);
            	}
            	else{
            		gc.lineTo(orgpoint.x + (i + 1) * hunit, orgpoint.y - count_arr[i] * vunit);
            	}
            }

            gc.strokeStyles = "blue";
            gc.lineWidth = 2;
            gc.stroke();

            //描点
            for (var i = 0; i < count_arr.length; i++) {
            	gc.beginPath();
            	gc.arc(orgpoint.x + (i + 1) * hunit, orgpoint.y - count_arr[i] * vunit, 5, 0, Math.PI * 2);
                gc.fillStyle = "red";
                gc.fill();
            }
        }

        function drawCirclePhtot(data_arr, color_arr, text_arr) {  
            //绘制饼图  
            //比例数据和颜色

            drawCircle("canvas_circle", data_arr, color_arr, text_arr);  
        }

        function deawLineChartPhtot(count_arr) {  
            //绘制折线图
            //横轴月份, 纵轴 订单数

            deawLineChart("canvas_linechart", count_arr);  
        }

    </script>  
    <script type="text/javascript">
    	function sum(arr) {
		    var len = arr.length;
		    if(len == 0){
		        return 0;
		    } else if (len == 1){
		        return arr[0];
		    } else {
		        return arr[0] + sum(arr.slice(1));
			}
		}

    	function load(){
	    	var data_arr = [];
	    	var text_arr =[];
	    	var count_arr = [];
	    	var obj = document.getElementById("monthtb");

	    	for (var i = 1; i < obj.rows[0].cells.length; i++) {
	    		text_arr.push(obj.rows[0].cells[i].innerHTML);
	    	}

	    	for (var i = 1; i < obj.rows[1].cells.length; i++) {
	    		count_arr.push(obj.rows[1].cells[i].innerHTML);
	    	}	    	

	    	for (var i = 1; i < obj.rows[2].cells.length; i++) {
	    		data_arr.push(obj.rows[2].cells[i].innerHTML);
	    	}
	    	
	        var color_arr = ["#00FF21", "#FFAA00", "#FF8800", "#FF5500", "#FF5500", "#FF1100", "#0011BB", "#0055BB", "#0088BB", "#00BB88", "#00AABB", "#FF4400"];  
	       
	    	drawCirclePhtot(data_arr.map(Number), color_arr, text_arr);
	    	deawLineChartPhtot(count_arr.map(Number));
    	}

    	window.onload = load;
    </script>
</head>
<body>
    <hr />
    <p>
		<ul>
			<span style="width:80px; display:inline-block;">整体统计</span>
			<span style="width:80px; display:inline-block;">个人统计</span>
		</ul>
    </p>
    <hr />

    <div>
	    <header>
			<h1>
			<span style="width:80px; display:inline-block;">战</span>
			<span style="width:80px; display:inline-block;">力</span>
			<span style="width:80px; display:inline-block;">统</span>
			<span style="width:80px; display:inline-block;">计</span>
			</h1>
		</header>

		<nav>
			<form action="" method="GET">
				<p style="line-height: 50px; text-align: center; background-color: AntiqueWhite;">
					<span style="width:120px; display:inline-block;">
						<button style="width: 100px" name="monthstat" type="submit" formaction="/stat/monthstat/" formmethod="GET">按月份统计</button>
					</span>
					<span style="width:120px; display:inline-block;">
						<button style="width: 100px" name="monthstat" type="submit" formaction="/stat/cusstat/" formmethod="GET">按客户统计</button>
					</span>
					<span style="width:120px; display:inline-block;">
						<button style="width: 100px" name="monthstat" type="submit" formaction="/stat/selesstat/" formmethod="GET">按业务员统计</button>
					</span>
				</p>
			</form>
		</nav>
		
		<section>
			<h1>{{showname}}</h1>
			
			{% if infolist %}
			<table id="monthtb" border="1" cellspacing="0">
				<tr>
					<td>年份</td>
					{% for item in infolist %}
		    			<td>{{item.date}}</td>
		    		{% endfor %}
				</tr>
				<tr>
					<td>订单数</td>
					{% for item in infolist %}
		    			<td>{{item.count}}</td>
		    		{% endfor %}
				</tr>
				<tr>
					<td>占比</td>
					{% for item in infolist %}
		    			<td>{{item.percent}}</td>
		    		{% endfor %}
				</tr>
			</table>
			{% endif %}

			<table>
				<tr>
					<td>
						<canvas id="canvas_circle" width="600" height="300" style="border:2px solid #000000;" ></canvas> 
			        </td>
			        <td>
						<canvas id="canvas_linechart" width="600" height="300" style="border:2px solid #000000;" ></canvas> 
			        </td>
				</tr>
			</table> 
			
		</section>
	</div>

</body>
</html>